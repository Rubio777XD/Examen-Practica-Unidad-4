{% extends "base.html" %}
{% block content %}
<section class="form-page">
  <h1>Iniciar sesión</h1>
  <div class="card card-glass">
    <form id="login-form">
      <label>Email
        <input name="email" type="email" required autocomplete="email">
      </label>
      <label>Contraseña
        <input name="password" type="password" required minlength="8" autocomplete="current-password">
      </label>
      <button type="submit" class="btn btn-primary">Ingresar</button>
    </form>
  </div>
  <p class="form-note">¿No tienes cuenta? <a href="{{ url_for('pages.register') }}">Regístrate aquí</a>.</p>
</section>
<script>
document.addEventListener('DOMContentLoaded', () => {
  if (window.getAuthUser && window.getAuthUser()) {
    window.location.replace('/');
    return;
  }

  const form = document.getElementById('login-form');
  if (!form) return;

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    try {
      const user = await window.api('/api/auth/login', { method: 'POST', body: data });
      if (window.setAuthUser) {
        window.setAuthUser(user);
      }
      window.showMessage('Sesión iniciada correctamente', 'success');
      window.location.replace('/');
    } catch (err) {
      const message = err?.status === 401 ? 'Credenciales inválidas' : window.errorMessageFrom(err);
      window.showMessage(message, 'error');
    }
  });
});
</script>
{% endblock %}
